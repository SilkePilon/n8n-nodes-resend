name: ğŸ” Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-scan:
    name: ğŸ› ï¸ Lint & Security Scan
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸš€ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
        
      - name: ğŸ”¨ Build Project
        run: npm run build
        
      - name: ğŸ§¹ Run ESLint
        run: npm run lint
        
      - name: ğŸ” Scan Community Package
        run: npx @n8n/scan-community-package n8n-nodes-resend
        
      - name: âœ… Validate Package Structure
        run: |
          echo "ğŸ” Checking package.json structure..."
          node -e "
            const pkg = require('./package.json');
            if (!pkg.n8n) throw new Error('Missing n8n configuration');
            if (!pkg.n8n.nodes || pkg.n8n.nodes.length === 0) throw new Error('No nodes defined');
            if (!pkg.n8n.credentials || pkg.n8n.credentials.length === 0) throw new Error('No credentials defined');
            console.log('âœ… Package structure is valid');
          "
          
      - name: ğŸ“Š Check Build Output
        run: |
          echo "ğŸ” Verifying build artifacts..."
          ls -la dist/
          if [ ! -f "dist/nodes/Resend/Resend.node.js" ]; then
            echo "âŒ Missing Resend.node.js"
            exit 1
          fi
          if [ ! -f "dist/nodes/Resend/ResendTrigger.node.js" ]; then
            echo "âŒ Missing ResendTrigger.node.js"
            exit 1
          fi
          if [ ! -f "dist/credentials/ResendApi.credentials.js" ]; then
            echo "âŒ Missing ResendApi.credentials.js"
            exit 1
          fi
          echo "âœ… All build artifacts present"

  test-compatibility:
    name: ğŸ§ª n8n Compatibility Test
    runs-on: ubuntu-latest
    needs: lint-and-scan
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
        
      - name: ğŸ”¨ Build Project
        run: npm run build
        
      - name: ğŸ§ª Test Package Installation
        run: |
          echo "ğŸ” Testing package installation simulation..."
          npm pack --dry-run
          
      - name: ğŸ“‹ Generate Package Report
        run: |
          echo "ğŸ“Š Package Information:" > package-report.txt
          echo "===================" >> package-report.txt
          echo "Package Name: $(node -p 'require("./package.json").name')" >> package-report.txt
          echo "Version: $(node -p 'require("./package.json").version')" >> package-report.txt
          echo "Node Engine: $(node -p 'require("./package.json").engines.node')" >> package-report.txt
          echo "n8n API Version: $(node -p 'require("./package.json").n8n.n8nNodesApiVersion')" >> package-report.txt
          echo "" >> package-report.txt
          echo "ğŸ“ File Structure:" >> package-report.txt
          echo "==================" >> package-report.txt
          find dist/ -type f -name "*.js" | sort >> package-report.txt
          echo "" >> package-report.txt
          echo "ğŸ“¦ Package Size:" >> package-report.txt
          echo "===============" >> package-report.txt
          du -sh dist/ >> package-report.txt
          cat package-report.txt
          
      - name: ğŸ“¤ Upload Package Report
        uses: actions/upload-artifact@v4
        with:
          name: package-report-${{ github.sha }}
          path: package-report.txt
          retention-days: 30

  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    needs: lint-and-scan
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: ğŸ” Run npm audit
        run: |
          npm audit --audit-level=moderate
          
      - name: ğŸ›¡ï¸ Check for known vulnerabilities
        run: |
          echo "ğŸ” Checking for security issues in dependencies..."
          npm ls --depth=0
          
      - name: ğŸ“Š License Check
        run: |
          echo "ğŸ“‹ Verifying license compatibility..."
          node -e "
            const pkg = require('./package.json');
            if (pkg.license !== 'MIT') {
              console.warn('âš ï¸ License is not MIT');
            } else {
              console.log('âœ… MIT license confirmed');
            }
          "

  format-check:
    name: ğŸ¨ Format & Style Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
        
      - name: ğŸ¨ Check Code Formatting
        run: |
          echo "ğŸ” Checking code formatting with Prettier..."
          npx prettier --check nodes credentials package.json || {
            echo "âŒ Code formatting issues found!"
            echo "ğŸ’¡ Run 'npm run format' to fix formatting issues"
            exit 1
          }
          echo "âœ… Code formatting is correct"
          
      - name: ğŸ“ Check Documentation
        run: |
          echo "ğŸ” Checking documentation files..."
          if [ ! -f "README.md" ]; then
            echo "âŒ Missing README.md"
            exit 1
          fi
          if [ ! -f "docs.md" ]; then
            echo "âŒ Missing docs.md"
            exit 1
          fi
          echo "âœ… Documentation files present"
          
          # Check README content
          if ! grep -q "n8n-nodes-resend" README.md; then
            echo "âš ï¸ README might not contain package name"
          fi
          
          echo "ğŸ“Š Documentation stats:"
          wc -l README.md docs.md

  notify-status:
    name: ğŸ“¢ Workflow Status
    runs-on: ubuntu-latest
    needs: [lint-and-scan, test-compatibility, security-audit, format-check]
    if: always()
    
    steps:
      - name: ğŸ“Š Report Results
        run: |
          echo "ğŸ¯ CI Pipeline Results"
          echo "====================="
          echo "Lint & Scan: ${{ needs.lint-and-scan.result }}"
          echo "Compatibility: ${{ needs.test-compatibility.result }}"
          echo "Security: ${{ needs.security-audit.result }}"
          echo "Format: ${{ needs.format-check.result }}"
          
          if [[ "${{ needs.lint-and-scan.result }}" == "success" && 
                "${{ needs.test-compatibility.result }}" == "success" && 
                "${{ needs.security-audit.result }}" == "success" && 
                "${{ needs.format-check.result }}" == "success" ]]; then
            echo "âœ… All checks passed! Ready for deployment ğŸš€"
          else
            echo "âŒ Some checks failed. Please review the logs above."
            exit 1
          fi
